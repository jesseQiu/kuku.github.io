<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>微信填坑 - Cease to struggle and you cease to live</title>
  <meta name="author" content="JesseChiu">
  
  <meta name="description" content="在微信开发过程中，经常会碰到各种坑，本文主要是记录在开发过程中遇到的坑，以便后期查询。

一、遇到的坑1.1 端口公众平台接口调用仅支持 80 端口
1.2 access_token公众平台以 access_token 为接口调用凭据，来调用接口，所有接口的调用需要先获取 access_token，">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="微信填坑"/>
  <meta property="og:site_name" content="Cease to struggle and you cease to live"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Cease to struggle and you cease to live" type="application/atom+xml">
  
  
    <link href="/favicon.ico" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/spacelab.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <!-- analytics -->
  



</head>


 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Cease to struggle and you cease to live</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="">
			  <i class="fa fa-rss"></i>Rss
			</a>
		  </li>
		  
		  <li>
			<a href="/sitemap.xml" title="">
			  <i class="fa fa-sitemap"></i>Sitemap
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header page-header-inverse ">		
			<h1 class="title title-inverse "> 微信填坑</h1>
		</div>		
	



<!-- 不蒜子统计 -->

        <span id="busuanzi_container_page_pv" style='display:none'>
              <i class="icon-smile icon"></i> 本文总阅读量: <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> 次
        </span>






<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <blockquote>
<p>在微信开发过程中，经常会碰到各种坑，本文主要是记录在开发过程中遇到的坑，以便后期查询。</p>
</blockquote>
<h2 id="一、遇到的坑"><a href="#一、遇到的坑" class="headerlink" title="一、遇到的坑"></a>一、遇到的坑</h2><h3 id="1-1-端口"><a href="#1-1-端口" class="headerlink" title="1.1 端口"></a>1.1 端口</h3><p>公众平台接口调用仅支持 <code>80</code> 端口</p>
<h3 id="1-2-access-token"><a href="#1-2-access-token" class="headerlink" title="1.2 access_token"></a>1.2 access_token</h3><p>公众平台以 access_token 为接口调用凭据，来调用接口，所有接口的调用需要先获取 access_token，access_token 在 2 小时内有效，过期需要重新获取，但1天内获取次数有限，开发者需自行存储，详见获取接口调用凭据（access_token）文档。</p>
<h3 id="1-3-40037"><a href="#1-3-40037" class="headerlink" title="1.3 40037"></a>1.3 40037</h3><p>如果后台返回 40037 表示微信测试账号，模板ID只能通过微信测试账号，新增的模板id才有效。<a href="http://zhengyunfei.iteye.com/blog/2228950" target="_blank" rel="noopener">参考</a></p>
<h3 id="1-4-40163"><a href="#1-4-40163" class="headerlink" title="1.4 40163"></a>1.4 40163</h3><p>参考: <a href="https://segmentfault.com/q/1010000009538036?sort=created" target="_blank" rel="noopener">微信网页授权 40163 code已被使用过</a></p>
<h3 id="1-5-40164"><a href="#1-5-40164" class="headerlink" title="1.5 40164"></a>1.5 40164</h3><p>是运行的 ip地址不在白公众号配置的 IP<br>白名单中。如果是在本地调试，在白名单里面增加本机IP就可以，如果放到线上了，则需要把白名单内的IP修改为服务器IP。</p>
<blockquote>
<p>linux 服务器获取本机外网 ip 地址方法</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">curl ip.cn</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">//当前 IP：59.60.x.x 来自：福建省福州市 电信</span></pre></td></tr></table></figure>
<blockquote>
<p>如果可以访问网页，直接访问 <a href="http://ip.qq.com/" target="_blank" rel="noopener">http://ip.qq.com/</a> 会显示你的IP地址</p>
</blockquote>
<h3 id="1-6-45047-客服接口下行条数超过上限"><a href="#1-6-45047-客服接口下行条数超过上限" class="headerlink" title="1.6 45047(客服接口下行条数超过上限)"></a>1.6 45047(客服接口下行条数超过上限)</h3><p>主要是微信在 2017-12-12 升级后出现,下面是网上找到的信息。</p>
<blockquote>
<p>用户和公众号有过互动后,发送 <code>20</code> 消息后,就会出现 <code>45047</code> ,这应该是微信对单个用户的客服消息做了限制,防止公众号发送垃圾消息。</p>
</blockquote>
<ul>
<li><a href="http://www.codes51.com/itwd/1191950.html" target="_blank" rel="noopener">errcode 45047</a></li>
</ul>
<h3 id="1-7-scan-push"><a href="#1-7-scan-push" class="headerlink" title="1.7 scan_push"></a>1.7 scan_push</h3><p>如果需要从菜单的扫一扫跳转页面，需要使用 scan_push 类型，并且二维码内容是 url 地址。</p>
<h3 id="1-8-jssdk"><a href="#1-8-jssdk" class="headerlink" title="1.8 jssdk"></a>1.8 jssdk</h3><ul>
<li><a href="http://blog.csdn.net/sinat_29843547/article/details/49357193" target="_blank" rel="noopener">nodejs 微信开发–调用微信 JSSDK</a></li>
<li>在微信中打开的网页，关闭退出到微信<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">document</span>.getElementById(<span class="string">'back'</span>).addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">		event.preventDefault();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">		WeixinJSBridge.invoke(<span class="string">'closeWindow'</span>, &#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h3 id="1-9-wechat-中间件"><a href="#1-9-wechat-中间件" class="headerlink" title="1.9 wechat 中间件"></a>1.9 wechat 中间件</h3></li>
<li>wechat 中间键会改写 session 和 wxsession(且每次请求的 sessionID 值都会变，但是保存在该 session 中的值不变)这个和 express-session 相互独立，这就导致了 req.session 的内容是不一样的。WeixinJS 接口<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理微信服务器发来的信息和事件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">router.use(<span class="string">'/'</span>, wechat(wechtConfig, (req, res, next) =&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  req.wxsession.openId = message.FromUserName;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  req.session.openId = message.FromUserName;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">`\n\n/wechat sessionID: <span class="subst">$&#123;req.sessionID&#125;</span> \nsession:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(req.session)&#125;</span>`</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">`\n\n/wechat wxsessionID: <span class="subst">$&#123;req.wxsessionID&#125;</span> \nwxsession:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(req.wxsession)&#125;</span>`</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// /wechat sessionID: si2KucNK_3hVFzUBJTijkabot05-4Quw</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">session:&#123;<span class="string">"cookie"</span>:&#123;<span class="string">"originalMaxAge"</span>:<span class="number">86400000</span>,<span class="string">"expires"</span>:<span class="string">"2017-07-29T08:08:25.642Z</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="string">"</span>,<span class="string">"httpOnly"</span>:<span class="literal">true</span>,<span class="string">"path"</span>:<span class="string">"/"</span>&#125;,<span class="string">"openId"</span>:<span class="string">"oS5_7v0W4VtnUASYLjJfl52qzt78"</span>&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"> <span class="comment">// /wechat wxsessionID: undefined</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">wxsession:&#123;<span class="string">"cookie"</span>:&#123;<span class="string">"originalMaxAge"</span>:<span class="number">86400000</span>,<span class="string">"expires"</span>:<span class="string">"2017-07-29T08:08:25.64</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="string">2Z"</span>,<span class="string">"httpOnly"</span>:<span class="literal">true</span>,<span class="string">"path"</span>:<span class="string">"/"</span>&#125;,<span class="string">"openId"</span>:<span class="string">"oS5_7v0W4VtnUASYLjJfl52qzt78"</span>&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// ...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 后续处理 中间件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">router.use(<span class="string">'/xxx'</span>,(req, res, next) =&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.log(<span class="string">`\n\n+++authority sessionID: <span class="subst">$&#123;req.sessionID&#125;</span> \nsession:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(req.session)&#125;</span>`</span> );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.log(<span class="string">`\n\n+++authority sessionID: <span class="subst">$&#123;req.wxsessionID&#125;</span> \nwxsession:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(req.wxsession)&#125;</span>`</span> );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// +++authority sessionID: oFVDtMqEB94TgXP9X0V6Xz4QmCSCLk4S</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">session:&#123;<span class="string">"cookie"</span>:&#123;<span class="string">"originalMaxAge"</span>:<span class="number">86400000</span>,<span class="string">"expires"</span>:<span class="string">"2017-07-29T08:08:26.406Z</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="string">"</span>,<span class="string">"httpOnly"</span>:<span class="literal">true</span>,<span class="string">"path"</span>:<span class="string">"/"</span>&#125;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// +++authority wxsessionID: undefined</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">wxsession:<span class="literal">undefined</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span></pre></td></tr></table></figure>
从上面的代码可以看出</li>
<li>wechat 中间件可以使用: session 和 wxsession</li>
<li>后续路由只能访问 session 且是一个新的 session (从 sessionID 值不同可确定)</li>
<li>原理：当从 wechat 中间件的 session 和 app 中使用的 session 相互独立，互不影响。</li>
</ul>
<blockquote>
<p>由于公共平台应用的客户端实际上是微信，所以采用传统的Cookie来实现会话并不现实，为此中间件模块在openid的基础上添加了Session支持。一旦服务端启用了 <code>connect.session</code> 中间件，在业务中就可以访问req.wxsession属性。这个属性与req.session行为类似。</p>
</blockquote>
<h3 id="1-10-微信服务器发送三次重复的排重问题"><a href="#1-10-微信服务器发送三次重复的排重问题" class="headerlink" title="1.10 微信服务器发送三次重复的排重问题"></a>1.10 微信服务器发送三次重复的排重问题</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uniqueMessageSet = <span class="keyword">new</span> <span class="built_in">Set</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkIsUniqueMsg</span>(<span class="params">msgId</span>)</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(uniqueMessageSet.has(msgId))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">console</span>.log(<span class="string">`\n&lt;&lt;&lt; checkIsUniqueMsg: already have msgId -&gt; <span class="subst">$&#123;uniqueMessageSet.size&#125;</span>\n`</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  &#125;<span class="keyword">else</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    uniqueMessageSet.add(msgId);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">console</span>.log(<span class="string">`\n&lt;&lt;&lt; checkIsUniqueMsg: add -&gt; <span class="subst">$&#123;uniqueMessageSet.size&#125;</span>\n`</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    setTimeout(<span class="function">(<span class="params">msgId</span>)=&gt;</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">      uniqueMessageSet.delete(msgId);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">console</span>.log(<span class="string">`\n&lt;&lt;&lt; checkIsUniqueMsg: timeout -&gt; <span class="subst">$&#123;uniqueMessageSet.size&#125;</span>\n`</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;,config.deleteUniqueMsgTimeout,msgId);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>参考: <a href="http://blog.csdn.net/langren1353464539/article/details/49898067" target="_blank" rel="noopener">微信服务器发送三次重复的排重问题</a></p>
<h3 id="1-11-页面跳转"><a href="#1-11-页面跳转" class="headerlink" title="1.11 页面跳转"></a>1.11 页面跳转</h3><p>微信不支持在关注或者扫描处理的逻辑代码中跳转页面；也就是必须先到公众号页面，再从里面点击进入其它页面。</p>
<h3 id="1-12-发送建议使用-reply"><a href="#1-12-发送建议使用-reply" class="headerlink" title="1.12 发送建议使用 reply"></a>1.12 发送建议使用 reply</h3><p>在 wechat 中间件里发送信息使用 <code>replay</code>，而不使用 <code>wechatApi.sendText</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">res.reply(&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  type: <span class="string">"text"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  content: data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用下面的函数发送会至少需要 5s 时间才能到达微信服务器，</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这样微信服务器在 5s 内未收到消息，就会连续发送三次</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">wechatApi.sendText(openId,data,(err,data)=&gt;&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">if</span>(err)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">		logger.error(err);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">return</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.log(<span class="string">`\nWechatAPI.sendText() success: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(data)&#125;</span>`</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<h3 id="1-13-viewEvent-错误"><a href="#1-13-viewEvent-错误" class="headerlink" title="1.13 viewEvent 错误"></a>1.13 viewEvent 错误</h3><p>从菜单点击进入，如果是 <code>viewEvent</code> 页面跳转事件，会报路径查找不到错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">[ERROR] lpt - POST /wechat/?signature=<span class="number">94</span>b5ac8040ac4919ab2522b15827b4b3ca12573e&amp;\timestamp=<span class="number">1502954629</span>&amp;nonce=<span class="number">737629849</span>&amp;openid=oS5_7v3io3nzrxMIVNWufQk1NrVI <span class="number">404</span></span></pre></td></tr></table></figure>
<p>这时只要添加一个根级路由，过滤即可解决</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">app.use(<span class="string">'/wechat'</span>, <span class="built_in">require</span>(<span class="string">'./routes/lpt-index'</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// lpt-index.js</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">router.all(<span class="string">'/'</span>,(req,res,next)=&gt;&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  res.end();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<h3 id="1-14-禁止网页在浏览器打开"><a href="#1-14-禁止网页在浏览器打开" class="headerlink" title="1.14 禁止网页在浏览器打开"></a>1.14 禁止网页在浏览器打开</h3><p>可以在每个页面的头部，判断下浏览器中是否包含 <code>MicroMessenger</code> 值来确认是否为微信内置浏览器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>((<span class="built_in">window</span>.navigator.userAgent.match(<span class="string">'MicroMessenger'</span>) === <span class="literal">null</span>) &amp;&amp; <span class="built_in">window</span>.location.href.match(<span class="string">'/not-wechat-navigator'</span>) === <span class="literal">null</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// 跳转到错误提示界面</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">window</span>.location=<span class="string">'/wechat/not-wechat-navigator/'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  &#125;)()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&lt;<span class="regexp">/script&gt;</span></span></pre></td></tr></table></figure>
<p>参考: <a href="http://www.jb51.net/article/57260.htm" target="_blank" rel="noopener">Javascript限制网页只能在微信内置浏览器中访问</a></p>
<h3 id="1-15-避免微信信息使用缓存内容"><a href="#1-15-避免微信信息使用缓存内容" class="headerlink" title="1.15 避免微信信息使用缓存内容"></a>1.15 避免微信信息使用缓存内容</h3><p>当我们使用下面的代码发送信息给微信(聊天界面)时，如果微信收到的信息内容是一样(显示时)的，当再次发送同样信息时，链接内容不同时，点击操作还是使用先前的内容，也就是微信内部判断，如果显示内容一样，就是使用了缓存。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendWelcomeMsg</span>(<span class="params">msg</span>)</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  res.reply(&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    type: <span class="string">"text"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    content: msg</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  res.end();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>例如:下面代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sendWelcomeMsg(<span class="string">`&lt;a href="http://xxx.yy.com/?id=1234&amp;name=jesse"&gt;点击开票&lt;/a&gt;`</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">sendWelcomeMsg(<span class="string">`&lt;a href="http://xxx.yy.com/?id=888&amp;name=jesse"&gt;点击开票&lt;/a&gt;`</span>)</span></pre></td></tr></table></figure>
<p>微信聊天界面收到两条信息，显示的内容都是 <code>点击开票</code>,但是两条信息的链接参数不是一样的。但是点击第二条信息时，跳转链接得到的参数还是第一条的 <code>id=1234&amp;name=jesse</code>，使用了先前的缓存内容。尝试了下面的方法还是一样:</p>
<ul>
<li>链接尾部添加一个动态数据(当前时间)</li>
<li>每次发送前连接地址转换为端网址显示(端网址每次都不同)</li>
<li>在服务端和网页端，添加清除缓存代码</li>
</ul>
<p>解决办法：<br>经过上面的失败尝试后，分析得出是依据显示内容来判断是否使用缓存，而且这个缓存是存在微信服务器内，所有在现实内容时，每次都添加一个不一样的参数，使用当前时间。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sendWelcomeMsg(<span class="string">`&lt;a href="http://xxx.yy.com/?id=1234&amp;name=jesse"&gt;点击开票&lt;/a&gt;\n\n当前时间:new Date()`</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">sendWelcomeMsg(<span class="string">`&lt;a href="http://xxx.yy.com/?id=888&amp;name=jesse"&gt;点击开票&lt;/a&gt;\n\n当前时间:new Date()`</span>)</span></pre></td></tr></table></figure>
<p>经过测试，解决了微信内部调整使用缓存问题。这个可以算个比较大的坑了。</p>
<h2 id="学习资源"><a href="#学习资源" class="headerlink" title="学习资源"></a>学习资源</h2><ul>
<li><a href="http://blog.csdn.net/zt_fucker/article/details/52535407" target="_blank" rel="noopener">微信开发必备外网映射工具—-Ngroke</a></li>
<li><a href="http://cloud.189.cn/t/6r2emymaI7Jz" target="_blank" rel="noopener">Nodejs实战之7天开发微信公众号</a> 慕课网收费视频下载</li>
<li><a href="https://pan.baidu.com/share/init?shareid=2851851900&uk=2977776567" target="_blank" rel="noopener">下载地址</a> 提取密码: ejkr</li>
<li><a href="https://github.com/soldair/node-qrcode" target="_blank" rel="noopener">node-qrcode</a> // js 生成二维码工具</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.imooc.com/learn/368" target="_blank" rel="noopener">初识Java微信公众号开发</a> 慕课网视频教程，有些基础知识讲解</li>
<li><a href="https://leancloud.cn/docs/webhosting_weixin.html" target="_blank" rel="noopener">leancloud 微信公众平台开发指南</a></li>
<li><a href="https://mp.weixin.qq.com/wiki/13/8d4957b72037e3308a0ca1b21f25ae8d.html" target="_blank" rel="noopener">公众号类型的接口权限说明</a></li>
<li><a href="https://mp.weixin.qq.com/wiki/10/6380dc743053a91c544ffd2b7c959166.html" target="_blank" rel="noopener">全局返回码说明</a></li>
<li><a href="https://mp.weixin.qq.com/debug" target="_blank" rel="noopener">在线接口调试接口网址</a></li>
<li><a href="https://leancloud.cn/docs/leanengine_cloudfunction_guide-node.html" target="_blank" rel="noopener">云函数开发指南</a></li>
<li><a href="https://leancloud.cn/docs/leanengine_webhosting_guide-node.html" target="_blank" rel="noopener">网站托管开发指南</a></li>
<li><a href="https://leancloud.cn/docs/leanstorage_guide-js.html" target="_blank" rel="noopener">JavaScript 开发指南</a></li>
<li><a href="https://leancloud.github.io/javascript-sdk/docs/" target="_blank" rel="noopener">JavaScript SDK API</a></li>
<li><a href="https://github.com/leancloud/leanengine-node-sdk/blob/master/API.md" target="_blank" rel="noopener">Node.js SDK API</a></li>
<li><a href="https://leancloud.cn/docs/leanengine_cli.html" target="_blank" rel="noopener">命令行工具使用指南</a></li>
<li><a href="https://leancloud.cn/docs/leanengine_faq.html" target="_blank" rel="noopener">云引擎常见问题和解答</a></li>
</ul>
	  

		<!-- 微信公众号关注 logo -->
		<div class="text-center">
			<img src="http://jessechiu.synology.me:5959/images/2020/11/13/wechat-subscribe.jpg">
			<span class="text-danger">全栈开发者微信公众号</span>
		</div>

	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/2017/08/05/2017-08-05-css-3d/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2017/07/14/2017-07-14-bom-FireReader/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>

  <!-- share -->
  

	</div> 
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2017-07-28 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/WeChat/">WeChat<span>4</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
  <hr>

<!-- 淘宝广告 -->

	<div id="myCarousel" class="carousel slide" data-ride="carousel">

		<!-- 轮播（Carousel）指标 -->
		<ol class="carousel-indicators">
			

				
					<li data-target="#myCarousel" data-slide-to="0" class="active"></li>
				

			
		</ol>   

		<!-- 轮播（Carousel）项目 -->
		<div class="carousel-inner">
			

				
					<div class="item active">
						<a href="https://item.taobao.com/item.htm?spm=a2oq0.12575281.0.0.25911debHjpm1G&ft=t&id=573820740653" title="汽车用增高坐垫司机女士座垫主驾驶员单座矮个子加高加厚座椅" target="blank">
							<img src="https://gd3.alicdn.com/imgextra/i4/76548092/TB22E6hF_JYBeNjy1zeXXahzVXa_!!76548092.jpg_400x400.jpg" alt="驾考增高坐垫" class="nofancybox">
							<div class="carousel-caption">驾考增高坐垫</div>
						</a>
					</div>	
				

			
		</div>

  </div> 


</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->


	</div>
  </div>

  <div class="container-narrow">
  <footer> 
<!-- 不蒜子统计 -->

    <span id="busuanzi_container_site_pv">
            本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv" style='display:none'>
            本站访客数 <span id="busuanzi_value_site_uv"> </span>人
    </span>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<span>
  &copy; 2021 JesseChiu
  
</span>

<span>
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/" target="_blank" rel="noopener">Freemind</a>.    
</span>
 </footer>
</div> <!-- container-narrow -->

  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

  
</body>

   </html>
